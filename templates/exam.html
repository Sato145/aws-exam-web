{% extends "base.html" %}

{% block title %}問題練習 - AWS Certified Cloud Practitioner 試験対策{% endblock %}

{% block extra_css %}
<style>
    .question-progress {
        height: 8px;
    }
    .choice-btn {
        text-align: left;
        white-space: normal;
        word-wrap: break-word;
        min-height: 60px;
        display: flex;
        align-items: center;
    }
    .question-number {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .timer {
        font-size: 1.2em;
        font-weight: bold;
    }
    .result-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div id="examContainer">
    <!-- 試験開始画面 -->
    <div id="startScreen" class="text-center">
        <div class="card">
            <div class="card-body py-5">
                <h2 class="mb-4"><i class="bi bi-play-circle"></i> 問題練習</h2>
                <p class="lead mb-4">{{ questions|length }}問の練習問題を開始します</p>
                <div class="mb-4">
                    <p><i class="bi bi-clock"></i> 制限時間なし（自分のペースで学習）</p>
                    <p><i class="bi bi-lightbulb"></i> 各問題に詳しい解説付き</p>
                    <p><i class="bi bi-graph-up"></i> 結果は自動的に記録されます</p>
                </div>
                <button class="btn btn-primary btn-lg" onclick="startExam()">
                    <i class="bi bi-play"></i> 開始
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg ms-2">
                    <i class="bi bi-arrow-left"></i> 戻る
                </a>
            </div>
        </div>
    </div>

    <!-- 問題画面 -->
    <div id="questionScreen" style="display: none;">
        <!-- プログレスバー -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>進捗状況</span>
                    <span id="progressText">1 / {{ questions|length }}</span>
                </div>
                <div class="progress question-progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 問題カード -->
        <div class="card question-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div id="questionNumber" class="question-number me-3">1</div>
                    <h5 class="mb-0">問題 <span id="currentQuestionNum">1</span></h5>
                </div>
                <div class="timer">
                    <i class="bi bi-clock"></i> <span id="timer">00:00</span>
                </div>
            </div>
            <div class="card-body">
                <p id="questionText" class="fs-5 mb-4"></p>
                <div id="choicesContainer" class="d-grid gap-2">
                    <!-- 選択肢がここに動的に追加される -->
                </div>
                <div id="explanationContainer" style="display: none;">
                    <div class="explanation mt-4">
                        <h6><i class="bi bi-lightbulb"></i> 解説</h6>
                        <p id="explanationText"></p>
                    </div>
                </div>
                <div class="mt-4 d-flex justify-content-between">
                    <button id="prevBtn" class="btn btn-outline-secondary" onclick="previousQuestion()" disabled>
                        <i class="bi bi-arrow-left"></i> 前の問題
                    </button>
                    <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()" disabled>
                        次の問題 <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果画面 -->
    <div id="resultScreen" style="display: none;">
        <div class="card">
            <div class="card-body text-center py-5">
                <h2 class="mb-4"><i class="bi bi-flag-checkered"></i> 試験完了</h2>
                <div class="result-summary p-4 mb-4">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <h3 id="totalScore" class="display-4">0%</h3>
                            <p class="mb-0">総合得点</p>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h3 id="correctCount" class="display-4">0</h3>
                            <p class="mb-0">正解数</p>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h3 id="totalQuestions" class="display-4">{{ questions|length }}</h3>
                            <p class="mb-0">総問題数</p>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h3 id="totalTime" class="display-4">00:00</h3>
                            <p class="mb-0">所要時間</p>
                        </div>
                    </div>
                </div>
                <div id="resultMessage" class="mb-4">
                    <!-- 結果メッセージがここに表示される -->
                </div>
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="restartExam()">
                        <i class="bi bi-arrow-clockwise"></i> もう一度挑戦
                    </button>
                    <a href="{{ url_for('scores') }}" class="btn btn-outline-primary">
                        <i class="bi bi-graph-up"></i> 成績確認
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-house"></i> ホームに戻る
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 問題データ
const questions = {{ questions | tojson }};
let currentQuestionIndex = 0;
let userAnswers = [];
let startTime = null;
let questionStartTime = null;

// タイマー関連
let timerInterval = null;

function startExam() {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('questionScreen').style.display = 'block';
    
    startTime = new Date();
    questionStartTime = new Date();
    
    // タイマー開始
    timerInterval = setInterval(updateTimer, 1000);
    
    // 最初の問題を表示
    showQuestion(0);
}

function updateTimer() {
    const now = new Date();
    const elapsed = Math.floor((now - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function showQuestion(index) {
    const question = questions[index];
    currentQuestionIndex = index;
    
    // プログレス更新
    const progress = ((index + 1) / questions.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${index + 1} / ${questions.length}`;
    
    // 問題表示
    document.getElementById('questionNumber').textContent = index + 1;
    document.getElementById('currentQuestionNum').textContent = index + 1;
    document.getElementById('questionText').textContent = question.question;
    
    // 選択肢表示
    const choicesContainer = document.getElementById('choicesContainer');
    choicesContainer.innerHTML = '';
    
    question.choices.forEach((choice, choiceIndex) => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary choice-btn';
        button.innerHTML = `<strong>${String.fromCharCode(65 + choiceIndex)}.</strong> ${choice}`;
        button.onclick = () => selectAnswer(choiceIndex);
        button.id = `choice-${choiceIndex}`;
        choicesContainer.appendChild(button);
    });
    
    // 解説を隠す
    document.getElementById('explanationContainer').style.display = 'none';
    
    // ボタン状態更新
    document.getElementById('prevBtn').disabled = index === 0;
    document.getElementById('nextBtn').disabled = true;
    document.getElementById('nextBtn').textContent = index === questions.length - 1 ? '結果を見る' : '次の問題';
    
    // 既に回答済みの場合は選択状態を復元
    if (userAnswers[index] !== undefined) {
        selectAnswer(userAnswers[index], false);
    }
}

function selectAnswer(choiceIndex, recordAnswer = true) {
    // 全ての選択肢をリセット
    document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.className = 'btn btn-outline-primary choice-btn';
    });
    
    // 選択された選択肢をハイライト
    const selectedBtn = document.getElementById(`choice-${choiceIndex}`);
    selectedBtn.className = 'btn btn-primary choice-btn';
    
    if (recordAnswer) {
        userAnswers[currentQuestionIndex] = choiceIndex;
        
        // 正解チェック
        const question = questions[currentQuestionIndex];
        const isCorrect = choiceIndex === question.answer;
        
        // 正解/不正解の表示
        setTimeout(() => {
            document.querySelectorAll('.choice-btn').forEach((btn, index) => {
                if (index === question.answer) {
                    btn.className = 'btn btn-success choice-btn correct-answer';
                } else if (index === choiceIndex && !isCorrect) {
                    btn.className = 'btn btn-danger choice-btn incorrect-answer';
                } else {
                    btn.className = 'btn btn-outline-secondary choice-btn';
                }
                btn.disabled = true;
            });
            
            // 解説表示
            document.getElementById('explanationText').textContent = question.explanation;
            document.getElementById('explanationContainer').style.display = 'block';
            
            // 次へボタンを有効化
            document.getElementById('nextBtn').disabled = false;
        }, 500);
    } else {
        // 既回答の場合は即座に結果表示
        const question = questions[currentQuestionIndex];
        document.querySelectorAll('.choice-btn').forEach((btn, index) => {
            if (index === question.answer) {
                btn.className = 'btn btn-success choice-btn correct-answer';
            } else if (index === choiceIndex && choiceIndex !== question.answer) {
                btn.className = 'btn btn-danger choice-btn incorrect-answer';
            } else {
                btn.className = 'btn btn-outline-secondary choice-btn';
            }
            btn.disabled = true;
        });
        
        document.getElementById('explanationText').textContent = question.explanation;
        document.getElementById('explanationContainer').style.display = 'block';
        document.getElementById('nextBtn').disabled = false;
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        showQuestion(currentQuestionIndex - 1);
    }
}

function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        showQuestion(currentQuestionIndex + 1);
    } else {
        showResult();
    }
}

function showResult() {
    clearInterval(timerInterval);
    
    document.getElementById('questionScreen').style.display = 'none';
    document.getElementById('resultScreen').style.display = 'block';
    
    // 結果計算
    let correctCount = 0;
    questions.forEach((question, index) => {
        if (userAnswers[index] === question.answer) {
            correctCount++;
        }
    });
    
    const totalQuestions = questions.length;
    const scorePercentage = Math.round((correctCount / totalQuestions) * 100);
    
    // 所要時間計算
    const endTime = new Date();
    const totalSeconds = Math.floor((endTime - startTime) / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // 結果表示
    document.getElementById('totalScore').textContent = scorePercentage + '%';
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('totalTime').textContent = timeString;
    
    // 結果メッセージ
    let message = '';
    let messageClass = '';
    if (scorePercentage >= 80) {
        message = '素晴らしい！合格レベルの実力です！';
        messageClass = 'alert alert-success';
    } else if (scorePercentage >= 70) {
        message = '良い結果です！もう少し頑張れば合格レベルです。';
        messageClass = 'alert alert-info';
    } else if (scorePercentage >= 60) {
        message = '基礎は身についています。復習して理解を深めましょう。';
        messageClass = 'alert alert-warning';
    } else {
        message = '基礎から復習することをお勧めします。';
        messageClass = 'alert alert-danger';
    }
    
    document.getElementById('resultMessage').innerHTML = `<div class="${messageClass}">${message}</div>`;
    
    // 成績を保存
    saveScore({
        date: new Date().toISOString(),
        totalQuestions: totalQuestions,
        correctAnswers: correctCount,
        score: scorePercentage,
        timeSpent: totalSeconds,
        timeString: timeString
    });
}

function saveScore(scoreData) {
    let scores = JSON.parse(localStorage.getItem('awsExamScores') || '[]');
    scores.push(scoreData);
    
    // 最新50件のみ保持
    if (scores.length > 50) {
        scores = scores.slice(-50);
    }
    
    localStorage.setItem('awsExamScores', JSON.stringify(scores));
}

function restartExam() {
    // リセット
    currentQuestionIndex = 0;
    userAnswers = [];
    startTime = null;
    questionStartTime = null;
    
    // 画面切り替え
    document.getElementById('resultScreen').style.display = 'none';
    document.getElementById('startScreen').style.display = 'block';
}
</script>
{% endblock %}